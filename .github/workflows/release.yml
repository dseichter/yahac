name: Build Binaries

on:
    push:
      tags:
        - 'v*'

jobs:

  build-windows:
      runs-on: windows-latest
      steps:

          - name: 'Checkout'
            uses: actions/checkout@v6

          - name: Set up Python
            uses: actions/setup-python@v6
            with:
              python-version: 3.14

          - name: Create and start virtual environment
            run: python3 -m venv venv

          - name: Install dependencies
            run: |
              . venv\Scripts\Activate.ps1
              pip install -r src/requirements.txt
              pip install pyinstaller-versionfile
              
          - name: Update version info
            run: |
              $VERSION = "${{ github.ref_name }}" -replace '^v', ''
              $NUMERIC_VERSION = $VERSION -replace '[^0-9.]', ''
              $VERSION_PARTS = ($NUMERIC_VERSION -split '\.') + @('0', '0', '0', '0')
              # Convert to integers to remove leading zeros
              $VERSION_PARTS = $VERSION_PARTS[0..3] | ForEach-Object { [int]($_ -replace '^$', '0') }
              (Get-Content version_info.py) -replace 'filevers=\(0, 3, 0, 0\)', "filevers=($($VERSION_PARTS[0]), $($VERSION_PARTS[1]), $($VERSION_PARTS[2]), $($VERSION_PARTS[3]))" -replace 'prodvers=\(0, 3, 0, 0\)', "prodvers=($($VERSION_PARTS[0]), $($VERSION_PARTS[1]), $($VERSION_PARTS[2]), $($VERSION_PARTS[3]))" -replace "u'FileVersion', u'0.3.0.0'", "u'FileVersion', u'$NUMERIC_VERSION.0'" -replace "u'ProductVersion', u'0.3.0.0'", "u'ProductVersion', u'$NUMERIC_VERSION.0'" | Set-Content version_info.py
            shell: powershell
            
          - name: Build Windows binary
            run: |
              . venv\Scripts\Activate.ps1
              pyinstaller yahac.spec
              move dist\yahac.exe yahac-${{ github.ref_name }}.exe
            shell: powershell

          - name: Upload artifact
            uses: actions/upload-artifact@v6
            with:
                  name: yahac-${{ github.ref_name }}.exe
                  path: yahac-${{ github.ref_name }}.exe   

  build-linux:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          include:
            - container: ubuntu:24.04
              name: ubuntu-24-04
              install_cmd: "apt update && apt-get install build-essential libgtk-3-dev python3-venv python3-pip wget xz-utils libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 -y"
            - container: archlinux:latest
              name: archlinux
              install_cmd: "pacman -Syu --noconfirm && pacman -S --noconfirm base-devel gtk3 python-virtualenv python-pip wget xz libxcb libxkbcommon-x11"
      container:
        image: ${{ matrix.container }}
      steps:

          - name: 'Checkout'
            uses: actions/checkout@v6

          - name: Install dependencies
            run: ${{ matrix.install_cmd }}

          - name: Set up Python
            uses: actions/setup-python@v6
            with:
              python-version: 3.14

          - name: Create and start virtual environment
            run: |
              python3 -m venv venv
              . venv/bin/activate

          - name: Install dependencies
            run: |
              . venv/bin/activate
              pip install -r src/requirements.txt

          - name: Build Linux binary
            run: |
              . venv/bin/activate
              pyinstaller yahac.spec
              mv dist/yahac yahac-${{ matrix.name }}-${{ github.ref_name }}

          - name: Upload artifact
            uses: actions/upload-artifact@v6
            with:
              name: yahac-${{ matrix.name }}-${{ github.ref_name }}
              path: yahac-${{ matrix.name }}-${{ github.ref_name }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    steps:
        - name: Checkout
          uses: actions/checkout@v6
          with:
            fetch-depth: 0
            
        - uses: actions/download-artifact@v7
          with:
            name: yahac-ubuntu-24-04-${{ github.ref_name }}
            path: .

        - uses: actions/download-artifact@v7
          with:
            name: yahac-${{ github.ref_name }}.exe
            path: .

        - uses: actions/download-artifact@v7
          with:
            name: yahac-archlinux-${{ github.ref_name }}
            path: .

        - name: Generate Release Notes
          id: release_notes
          run: |
            # Get commits since last tag
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              COMMITS=$(git log --pretty=format:"* %s by @%an in %H" --no-merges)
            else
              COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"* %s by @%an in %H" --no-merges)
            fi
            
            # Separate dependabot and regular changes
            DEPENDABOT_CHANGES=$(echo "$COMMITS" | grep -i "dependabot" || true)
            OTHER_CHANGES=$(echo "$COMMITS" | grep -v -i "dependabot" || true)
            
            # Build release notes
            RELEASE_NOTES="## What's Changed\n"
            if [ ! -z "$OTHER_CHANGES" ]; then
              RELEASE_NOTES="${RELEASE_NOTES}${OTHER_CHANGES}\n\n"
            fi
            
            if [ ! -z "$DEPENDABOT_CHANGES" ]; then
              RELEASE_NOTES="${RELEASE_NOTES}## Dependency Updates\n${DEPENDABOT_CHANGES}\n\n"
            fi
            
            RELEASE_NOTES="${RELEASE_NOTES}**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...${{ github.ref_name }}"
            
            # Save to output
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
            echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

        - name: Create Release
          id: create_release
          uses: softprops/action-gh-release@v2
          with:
            tag_name: ${{ github.ref_name }}
            name: Release ${{ github.ref_name }}
            body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
            draft: false
            prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') }}
            files: |
              yahac-ubuntu-24-04-${{ github.ref_name }}
              yahac-archlinux-${{ github.ref_name }}
              yahac-${{ github.ref_name }}.exe
              
        - name: Trigger Debian package build
          uses: actions/github-script@v8
          with:
            script: |
              github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'debian.yml',
                ref: context.ref
              })
              
        - name: Trigger Arch package build
          uses: actions/github-script@v8
          with:
            script: |
              github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'arch.yml',
                ref: context.ref
              })

